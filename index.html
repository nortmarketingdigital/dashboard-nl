<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Customer Success</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-orange: #ff6600;
            --dark-text: #1a1a1a;
            --gray-text: #666666;
            --light-gray: #f5f5f5;
            --border-gray: #e0e0e0;
            --white: #ffffff;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #fafafa;
            color: var(--dark-text);
            line-height: 1.6;
        }

        .dashboard-wrapper { display: flex; min-height: 100vh; }
        
        .sidebar {
            width: 260px;
            background: var(--white);
            border-right: 1px solid var(--border-gray);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo-area {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid var(--border-gray);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-orange);
            letter-spacing: -0.5px;
        }

        .logo-sub {
            font-size: 0.75rem;
            color: var(--gray-text);
            margin-top: 0.25rem;
            font-weight: 500;
        }

        .nav { padding: 1.5rem 0; }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.875rem 1.5rem;
            color: var(--gray-text);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .nav-item:hover {
            background: var(--light-gray);
            color: var(--dark-text);
        }

        .nav-item.active {
            color: var(--primary-orange);
            background: rgba(255, 102, 0, 0.05);
            border-left: 3px solid var(--primary-orange);
        }

        .nav-icon { margin-right: 0.75rem; font-size: 1.25rem; }

        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 2rem;
            max-width: 1600px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-gray);
        }

        .header-left h1 {
            font-size: 2rem;
            font-weight: 800;
            color: var(--dark-text);
            margin-bottom: 0.25rem;
        }

        .header-subtitle {
            font-size: 0.875rem;
            color: var(--gray-text);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary-orange);
            color: white;
        }

        .btn-primary:hover {
            background: #e55a00;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 102, 0, 0.2);
        }

        .btn-outline {
            background: white;
            color: var(--dark-text);
            border: 1px solid var(--border-gray);
        }

        .btn-outline:hover {
            border-color: var(--primary-orange);
            color: var(--primary-orange);
        }

        .config-box {
            background: white;
            border: 2px dashed var(--border-gray);
            border-radius: 12px;
            padding: 2.5rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .config-box h3 {
            font-size: 1.25rem;
            color: var(--dark-text);
            margin-bottom: 0.5rem;
        }

        .config-box p {
            color: var(--gray-text);
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .config-input {
            width: 100%;
            max-width: 600px;
            padding: 0.875rem 1rem;
            border: 1px solid var(--border-gray);
            border-radius: 6px;
            font-size: 0.875rem;
            font-family: 'Courier New', monospace;
            margin: 0 auto 1rem;
        }

        .config-input:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        .layer-content { display: none; }
        .layer-content.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            border: 1px solid var(--border-gray);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s;
        }

        .metric-card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--gray-text);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--dark-text);
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .metric-card.accent .metric-value { color: var(--primary-orange); }

        .metric-change {
            font-size: 0.8rem;
            color: var(--gray-text);
        }

        .metric-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .badge-success { background: rgba(34, 197, 94, 0.1); color: var(--success); }
        .badge-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .badge-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }

        .chart-section {
            background: white;
            border: 1px solid var(--border-gray);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--dark-text);
        }

        .chart-bar-wrapper { margin-bottom: 1rem; }

        .bar-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .bar-label { font-weight: 600; color: var(--dark-text); }
        .bar-value { color: var(--gray-text); font-weight: 500; }

        .bar-track {
            height: 8px;
            background: var(--light-gray);
            border-radius: 4px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-orange), #ff8833);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .bar-fill.success { background: linear-gradient(90deg, var(--success), #4ade80); }
        .bar-fill.danger { background: linear-gradient(90deg, var(--danger), #f87171); }

        .table-container {
            background: white;
            border: 1px solid var(--border-gray);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .table-header {
            padding: 1.25rem 1.5rem;
            background: var(--light-gray);
            border-bottom: 1px solid var(--border-gray);
        }

        .table-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--dark-text);
        }

        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--light-gray); }

        th {
            padding: 1rem 1.5rem;
            text-align: left;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--gray-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-gray);
            font-size: 0.875rem;
            color: var(--dark-text);
        }

        tbody tr:hover { background: var(--light-gray); }

        .status-badge {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-success { background: rgba(34, 197, 94, 0.1); color: var(--success); }
        .status-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .status-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }

        .loading-state { text-align: center; padding: 3rem; }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-gray);
            border-top-color: var(--primary-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-item {
            background: white;
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            padding: 1.25rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--gray-text);
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 1rem; }
            .header { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .metrics-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="dashboard-wrapper">
        <aside class="sidebar">
            <div class="logo-area">
                <div class="logo">CS Dashboard</div>
                <div class="logo-sub">Customer Success Intelligence</div>
            </div>
            
            <nav class="nav">
                <div class="nav-item active" data-layer="layer1">
                    <span class="nav-icon">üìä</span>
                    <span>Vis√£o Executiva</span>
                </div>
                <div class="nav-item" data-layer="layer2">
                    <span class="nav-icon">üë•</span>
                    <span>Gest√£o</span>
                </div>
                <div class="nav-item" data-layer="layer3">
                    <span class="nav-icon">‚è±Ô∏è</span>
                    <span>Operacional</span>
                </div>
                <div class="nav-item" data-layer="layer4">
                    <span class="nav-icon">‚úì</span>
                    <span>Governan√ßa</span>
                </div>
                <div class="nav-item" data-layer="layer5">
                    <span class="nav-icon">üß†</span>
                    <span>Intelig√™ncia</span>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <div class="header">
                <div class="header-left">
                    <h1>Dashboard de Customer Success</h1>
                    <div class="header-subtitle" id="lastUpdate">√öltima atualiza√ß√£o: --</div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-outline" onclick="window.location.reload()">‚öôÔ∏è Configurar</button>
                    <button class="btn btn-primary" onclick="loadData()">‚Üª Atualizar Dados</button>
                </div>
            </div>

            <div class="config-box" id="configSection">
                <h3>‚öôÔ∏è Configura√ß√£o do Google Sheets</h3>
                <p>Cole o link da sua planilha publicada como CSV para come√ßar</p>
                <input type="text" class="config-input" id="sheetsUrl" placeholder="https://docs.google.com/spreadsheets/d/SEU_ID/export?format=csv&gid=0">
                <button class="btn btn-primary" onclick="saveConfig()">Conectar e Carregar</button>
            </div>

            <div class="layer-content active" id="layer1">
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Total de Clientes</div>
                        <div class="metric-value" id="totalClientes">--</div>
                        <div class="metric-change">Ativos na base</div>
                    </div>
                    <div class="metric-card accent">
                        <div class="metric-label">CSAT M√©dio</div>
                        <div class="metric-value" id="csatMedio">--</div>
                        <div class="metric-change">√çndice de satisfa√ß√£o</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Em Risco</div>
                        <div class="metric-value" id="clientesRisco">--</div>
                        <div class="metric-badge badge-danger" id="percRisco">--% da base</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Estrat√©gicos</div>
                        <div class="metric-value" id="clientesEstrategicos">--</div>
                        <div class="metric-badge badge-success" id="percEstrategicos">--% da base</div>
                    </div>
                </div>
                <div class="chart-section">
                    <div class="chart-header"><div class="chart-title">Distribui√ß√£o por Status</div></div>
                    <div id="statusChart"></div>
                </div>
                <div class="chart-section">
                    <div class="chart-header"><div class="chart-title">Indicadores de Sa√∫de</div></div>
                    <div id="saudeChart"></div>
                </div>
            </div>

            <div class="layer-content" id="layer2">
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-number" id="totalConsultores">--</div>
                        <div class="stat-label">Consultores Ativos</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="mediaClientesConsultor">--</div>
                        <div class="stat-label">Clientes por Consultor</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="clientesSemCSAT">--</div>
                        <div class="stat-label">Sem CSAT</div>
                    </div>
                </div>
                <div class="table-container">
                    <div class="table-header"><div class="table-title">Performance por Consultor</div></div>
                    <table id="consultorTable">
                        <thead><tr><th>Consultor</th><th>Clientes</th><th>CSAT M√©dio</th><th>Multi-Produto</th><th>Horas</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="chart-section">
                    <div class="chart-header"><div class="chart-title">Distribui√ß√£o de Produtos</div></div>
                    <div id="produtosChart"></div>
                </div>
            </div>

            <div class="layer-content" id="layer3">
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Horas Faturadas</div>
                        <div class="metric-value" id="totalHorasFaturadas">--</div>
                        <div class="metric-badge badge-success">Produtivo</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Horas N√£o Faturadas</div>
                        <div class="metric-value" id="totalHorasNaoFaturadas">--</div>
                        <div class="metric-badge badge-warning">Investimento</div>
                    </div>
                    <div class="metric-card accent">
                        <div class="metric-label">Taxa N√£o Faturamento</div>
                        <div class="metric-value" id="taxaNaoFaturamento">--</div>
                        <div class="metric-change">% do total</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Receita Mensal</div>
                        <div class="metric-value" id="receitaMensal">--</div>
                        <div class="metric-change">Contratos ativos</div>
                    </div>
                </div>
                <div class="chart-section">
                    <div class="chart-header"><div class="chart-title">Distribui√ß√£o de Horas</div></div>
                    <div id="horasChart"></div>
                </div>
                <div class="table-container">
                    <div class="table-header"><div class="table-title">Top 10 Clientes por Rentabilidade</div></div>
                    <table id="rentabilidadeTable">
                        <thead><tr><th>Cliente</th><th>Valor Contrato</th><th>Horas</th><th>Valor/Hora</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="layer-content" id="layer4">
                <div class="metrics-grid">
                    <div class="metric-card accent">
                        <div class="metric-label">Preenchimento</div>
                        <div class="metric-value" id="preenchimentoCompleto">--</div>
                        <div class="metric-change">Dados completos</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Sem Consultor</div>
                        <div class="metric-value" id="clientesSemConsultor">--</div>
                        <div class="metric-badge badge-warning">Requer aten√ß√£o</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Sem Bimestre</div>
                        <div class="metric-value" id="clientesSemBimestre">--</div>
                        <div class="metric-badge badge-warning">Pendente</div>
                    </div>
                </div>
                <div class="chart-section">
                    <div class="chart-header"><div class="chart-title">Qualidade dos Dados</div></div>
                    <div id="qualidadeChart"></div>
                </div>
                <div class="table-container">
                    <div class="table-header"><div class="table-title">Alertas de Governan√ßa</div></div>
                    <table id="alertasTable">
                        <thead><tr><th>Cliente</th><th>Alerta</th><th>Prioridade</th><th>A√ß√£o</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="layer-content" id="layer5">
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-number" id="clientesSilenciosos">--</div>
                        <div class="stat-label">Clientes Silenciosos</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="clientesAncora">--</div>
                        <div class="stat-label">Clientes √Çncora</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="produtividadeCS">--</div>
                        <div class="stat-label">Produtividade (R$/h)</div>
                    </div>
                </div>
                <div class="table-container">
                    <div class="table-header"><div class="table-title">üö® Clientes Silenciosos de Risco</div></div>
                    <table id="silenciososTable">
                        <thead><tr><th>Cliente</th><th>Complexidade</th><th>Risco</th><th>A√ß√£o Priorit√°ria</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="table-container">
                    <div class="table-header"><div class="table-title">‚≠ê Clientes √Çncora</div></div>
                    <table id="ancoraTable">
                        <thead><tr><th>Cliente</th><th>CSAT</th><th>Produtos</th><th>Potencial</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="chart-section">
                    <div class="chart-header"><div class="chart-title">Produtividade por Consultor</div></div>
                    <div id="produtividadeChart"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let GOOGLE_SHEETS_URL = localStorage.getItem('sheetsUrl') || '';
        let dadosClientes = [];

        document.addEventListener('DOMContentLoaded', function() {
            setupNavigation();
            if (GOOGLE_SHEETS_URL) {
                document.getElementById('configSection').style.display = 'none';
                loadData();
            }
        });

        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    document.querySelectorAll('.layer-content').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    const layerId = this.getAttribute('data-layer');
                    document.getElementById(layerId).classList.add('active');
                    if (dadosClientes.length > 0) renderLayerData(layerId);
                });
            });
        }

        function saveConfig() {
            const url = document.getElementById('sheetsUrl').value.trim();
            if (!url) { alert('Cole o link!'); return; }
            GOOGLE_SHEETS_URL = url;
            localStorage.setItem('sheetsUrl', url);
            document.getElementById('configSection').style.display = 'none';
            loadData();
        }

        async function loadData() {
            if (!GOOGLE_SHEETS_URL) { alert('Configure primeiro!'); return; }
            try {
                showLoading();
                const response = await fetch(GOOGLE_SHEETS_URL);
                const csvText = await response.text();
                dadosClientes = parseCSV(csvText);
                renderLayer1(); renderLayer2(); renderLayer3(); renderLayer4(); renderLayer5();
                document.getElementById('lastUpdate').textContent = `√öltima atualiza√ß√£o: ${new Date().toLocaleString('pt-BR')}`;
                hideLoading();
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar!');
                hideLoading();
            }
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = lines[i].split(',');
                const obj = {};
                headers.forEach((header, index) => {
                    let value = values[index] ? values[index].trim() : '';
                    if (!isNaN(value) && value !== '') value = parseFloat(value);
                    obj[header] = value;
                });
                if (obj.Cliente) data.push(obj);
            }
            return data;
        }

        function renderLayer1() {
            const total = dadosClientes.length;
            const csat = calcularCSATMedio();
            const risco = dadosClientes.filter(c => c.Flag_Risco === 'SIM').length;
            const estrategicos = dadosClientes.filter(c => c.Cliente_Estrategico === 'SIM').length;
            document.getElementById('totalClientes').textContent = total;
            document.getElementById('csatMedio').textContent = csat.toFixed(1);
            document.getElementById('clientesRisco').textContent = risco;
            document.getElementById('percRisco').textContent = `${((risco/total)*100).toFixed(1)}% da base`;
            document.getElementById('clientesEstrategicos').textContent = estrategicos;
            document.getElementById('percEstrategicos').textContent = `${((estrategicos/total)*100).toFixed(1)}% da base`;
            renderStatusChart(); renderSaudeChart();
        }

        function renderStatusChart() {
            const risco = dadosClientes.filter(c => c.Flag_Risco === 'SIM').length;
            const estrategicos = dadosClientes.filter(c => c.Cliente_Estrategico === 'SIM').length;
            const estavel = dadosClientes.length - risco - estrategicos;
            const total = dadosClientes.length;
            const html = `
                <div class="chart-bar-wrapper"><div class="bar-info"><span class="bar-label">Em Risco</span><span class="bar-value">${risco} clientes</span></div><div class="bar-track"><div class="bar-fill danger" style="width: ${(risco/total)*100}%"></div></div></div>
                <div class="chart-bar-wrapper"><div class="bar-info"><span class="bar-label">Est√°vel</span><span class="bar-value">${estavel} clientes</span></div><div class="bar-track"><div class="bar-fill" style="width: ${(estavel/total)*100}%"></div></div></div>
                <div class="chart-bar-wrapper"><div class="bar-info"><span class="bar-label">Estrat√©gico</span><span class="bar-value">${estrategicos} clientes</span></div><div class="bar-track"><div class="bar-fill success" style="width: ${(estrategicos/total)*100}%"></div></div></div>
            `;
            document.getElementById('statusChart').innerHTML = html;
        }

        function renderSaudeChart() {
            const comCSAT = dadosClientes.filter(c => c.CSAT_Interno > 0).length;
            const multiProduto = dadosClientes.filter(c => c.Qtd_Produtos >= 2).length;
            const comMelhorias = dadosClientes.filter(c => c.Melhorias === 'Alto' || c.Melhorias === 'M√©dio').length;
            const total = dadosClientes.length;
            const html = `
                <div class="chart-bar-wrapper"><div class="bar-info"><span class="bar-label">Com CSAT Medido</span><span class="bar-value">${((comCSAT/total)*100).toFixed(1)}%</span></div><div class="bar-track"><div class="bar-fill" style="width: ${(comCSAT/total)*100}%"></div></div></div>
                <div class="chart-bar-wrapper"><div class="bar-info"><span class="bar-label">Multi-Produto</span><span class="bar-value">${((multiProduto/total)*100).toFixed(1)}%</span></div><div class="bar-track"><div class="bar-fill" style="width: ${(multiProduto/total)*100}%"></div></div></div>
                <div class="chart-bar-wrapper"><div class="bar-info"><span class="bar-label">Com Melhorias Ativas</span><span class="bar-value">${((comMelhorias/total)*100).toFixed(1)}%</span></div><div class="bar-track"><div class="bar-fill success" style="width: ${(comMelhorias/total)*100}%"></div></div></div>
            `;
            document.getElementById('saudeChart').innerHTML = html;
        }

        function renderLayer2() {
            const consultores = [...new Set(dadosClientes.map(c => c.Consultor_Referencia))];
            document.getElementById('totalConsultores').textContent = consultores.length;
            document.getElementById('mediaClientesConsultor').textContent = (dadosClientes.length / consultores.length).toFixed(1);
            document.getElementById('clientesSemCSAT').textContent = dadosClientes.filter(c => !c.CSAT_Interno).length;
            renderConsultorTable(); renderProdutosChart();
        }

        function renderConsultorTable() {
            const consultores = {};
            dadosClientes.forEach(c => {
                const cons = c.Consultor_Referencia;
                if (!consultores[cons]) consultores[cons] = { clientes: 0, csats: [], multi: 0, horas: 0 };
                consultores[cons].clientes++;
                if (c.CSAT_Interno) consultores[cons].csats.push(c.CSAT_Interno);
                if (c.Qtd_Produtos >= 2) consultores[cons].multi++;
                consultores[cons].horas += c.Horas_Faturadas || 0;
            });
            let html = '';
            Object.keys(consultores).forEach(cons => {
                const d = consultores[cons];
                const csat = d.csats.length > 0 ? (d.csats.reduce((a,b) => a+b) / d.csats.length).toFixed(1) : '--';
                html += `<tr><td><strong>${cons}</strong></td><td>${d.clientes}</td><td>${csat}</td><td>${d.multi} (${((d.multi/d.clientes)*100).toFixed(0)}%)</td><td>${d.horas.toFixed(0)}h</td></tr>`;
            });
            document.querySelector('#consultorTable tbody').innerHTML = html;
        }

        function renderProdutosChart() {
            const dist = {
                '1 produto': dadosClientes.filter(c => c.Qtd_Produtos === 1).length,
                '2 produtos': dadosClientes.filter(c => c.Qtd_Produtos === 2).length,
                '3 produtos': dadosClientes.filter(c => c.Qtd_Produtos === 3).length,
                '4+ produtos': dadosClientes.filter(c => c.Qtd_Produtos >= 4).length
            };
            const total = dadosClientes.length;
            let html = '';
            Object.keys(dist).forEach(key => {
                html += `<div class="chart-bar-wrapper"><div class="bar-info"><span class="bar-label">${key}</span><span class="bar-value">${dist[key]} clientes</span></div><div class="bar-track"><div class="bar-fill" style="width: ${(dist[key]/total)*100}%"></div></div></div>`;
            });
            document.getElementById('produtosChart').innerHTML = html;
        }

        function renderLayer3() {
            const faturadas = dadosClientes.reduce((s, c) => s + (c.Horas_Faturadas || 0), 0);
            const naoFaturadas = dadosClientes.reduce((s, c) => s + (c.Horas_Nao_Faturadas || 0), 0);
            const taxa = ((naoFaturadas / (faturadas + naoFaturadas)) * 100).toFixed(1);
            const receita = dadosClientes.reduce((s, c) => s + (c.Valor_Contrato_Mensal || 0), 0);
            document.getElementById('totalHorasFaturadas').textContent = faturadas.toFixed(0) + 'h';
            document.getElementById('totalHorasNaoFaturadas').textContent = naoFaturadas.toFixed(0) + 'h';
            document.getElementById('taxaNaoFaturamento').textContent = taxa + '%';
            document.getElementById('receitaMensal').textContent = 'R$ ' + receita.toLocaleString('pt-BR');
            renderHorasChart(faturadas, naoFaturadas); renderRentabilidadeTable();
        }

        function renderHorasChart(fat, naoFat) {
            const total = fat + naoFat;
            const html = `
                <div class="chart-bar-wrapper"><div class="bar-info"><span class="bar-label">Horas Faturadas</span><span class="bar-value">${fat.toFixed(0)}h</span></div><div class="bar-track"><div class="bar-fill success" style="width: ${(fat/total)*100}%"></div></div></div>
                <div class="chart-bar-wrapper"><div class="bar-info"><span class="bar-label">Horas N√£o Faturadas</span><span class="bar-value">${naoFat.toFixed(0)}h</span></div><div class="bar-track"><div class="bar-fill" style="width: ${(naoFat/total)*100}%; background: linear-gradient(90deg, #f59e0b, #fbbf24);"></div></div></div>
            `;
            document.getElementById('horasChart').innerHTML = html;
        }

        function renderRentabilidadeTable() {
            const rent = dadosClientes.filter(c => c.Horas_Faturadas > 0 && c.Valor_Contrato_Mensal > 0)
                .map(c => ({ cliente: c.Cliente, valor: c.Valor_Contrato_Mensal, horas: (c.Horas_Faturadas||0)+(c.Horas_Nao_Faturadas||0), vh: c.Valor_Contrato_Mensal/((c.Horas_Faturadas||0)+(c.Horas_Nao_Faturadas||0)) }))
                .sort((a, b) => b.vh - a.vh).slice(0, 10);
            let html = '';
            rent.forEach(r => {
                const st = r.vh >= 100 ? 'success' : r.vh >= 50 ? 'warning' : 'danger';
                const stText = st === 'success' ? 'Excelente' : st === 'warning' ? 'Adequado' : 'Aten√ß√£o';
                html += `<tr><td><strong>${r.cliente}</strong></td><td>R$ ${r.valor.toLocaleString('pt-BR')}</td><td>${r.horas.toFixed(0)}h</td><td><strong>R$ ${r.vh.toFixed(0)}/h</strong></td><td><span class="status-badge status-${st}">${stText}</span></td></tr>`;
            });
            document.querySelector('#rentabilidadeTable tbody').innerHTML = html;
        }

        function renderLayer4() {
            const campos = ['Cliente', 'Consultor_Referencia', 'CSAT_Interno', 'Bimestre_Ref', 'Produtos_Implementados'];
            let preenchido = 0, totalCampos = dadosClientes.length * campos.length;
            dadosClientes.forEach(c => campos.forEach(f => { if (c[f]) preenchido++; }));
            const perc = ((preenchido / totalCampos) * 100).toFixed(1);
            const semCons = dadosClientes.filter(c => !c.Consultor_Referencia).length;
            const semBim = dadosClientes.filter(c => !c.Bimestre_Ref).length;
            document.getElementById('preenchimentoCompleto').textContent = perc + '%';
            document.getElementById('clientesSemConsultor').textContent = semCons;
            document.getElementById('clientesSemBimestre').textContent = semBim;
            renderQualidadeChart(preenchido, totalCampos); renderAlertasTable();
        }

        function renderQualidadeChart(p, t) {
            const perc = (p / t) * 100;
            const html = `<div style="text-align: center; padding: 2rem;"><div style="font-size: 4rem; font-weight: 800; color: var(--primary-orange); margin-bottom: 1rem;">${perc.toFixed(1)}%</div><div style="color: var(--gray-text);">${p} de ${t} campos preenchidos</div></div>`;
            document.getElementById('qualidadeChart').innerHTML = html;
        }

        function renderAlertasTable() {
            const alertas = [];
            dadosClientes.forEach(c => {
                if (!c.CSAT_Interno) alertas.push({ cliente: c.Cliente, alerta: 'CSAT n√£o medido', prio: 'Alta', acao: 'Realizar pesquisa' });
                if (c.Flag_Risco === 'SIM') alertas.push({ cliente: c.Cliente, alerta: 'Cliente em risco', prio: 'Cr√≠tica', acao: 'Reuni√£o imediata' });
                if (!c.Bimestre_Ref) alertas.push({ cliente: c.Cliente, alerta: 'Sem acompanhamento', prio: 'M√©dia', acao: 'Agendar checkpoint' });
            });
            let html = '';
            alertas.slice(0, 15).forEach(a => {
                const st = a.prio === 'Cr√≠tica' ? 'danger' : a.prio === 'Alta' ? 'warning' : 'success';
                html += `<tr><td><strong>${a.cliente}</strong></td><td>${a.alerta}</td><td><span class="status-badge status-${st}">${a.prio}</span></td><td>${a.acao}</td></tr>`;
            });
            document.querySelector('#alertasTable tbody').innerHTML = html || '<tr><td colspan="4" style="text-align: center; padding: 2rem;">‚úÖ Nenhum alerta</td></tr>';
        }

        function renderLayer5() {
            const silenciosos = dadosClientes.filter(c => c.Complexidade === 'Alta' && !c.CSAT_Interno && (c.Melhorias === 'Nenhum' || c.Melhorias === 'Baixo') && c.Novas_Vendas !== 'Sim');
            const ancora = dadosClientes.filter(c => c.CSAT_Interno >= 8 && c.Qtd_Produtos >= 3);
            const receita = dadosClientes.reduce((s, c) => s + (c.Valor_Contrato_Mensal || 0), 0);
            const horas = dadosClientes.reduce((s, c) => s + (c.Horas_Faturadas || 0) + (c.Horas_Nao_Faturadas || 0), 0);
            const prod = receita / horas;
            document.getElementById('clientesSilenciosos').textContent = silenciosos.length;
            document.getElementById('clientesAncora').textContent = ancora.length;
            document.getElementById('produtividadeCS').textContent = prod.toFixed(0);
            renderSilenciososTable(silenciosos); renderAncoraTable(ancora); renderProdutividadeChart();
        }

        function renderSilenciososTable(s) {
            let html = '';
            s.forEach(c => { html += `<tr><td><strong>${c.Cliente}</strong></td><td><span class="status-badge status-danger">${c.Complexidade}</span></td><td><span class="status-badge status-danger">Cr√≠tico</span></td><td>Reuni√£o executiva + plano de a√ß√£o</td></tr>`; });
            document.querySelector('#silenciososTable tbody').innerHTML = html || '<tr><td colspan="4" style="text-align: center; padding: 2rem;">‚úÖ Nenhum cliente silencioso</td></tr>';
        }

        function renderAncoraTable(a) {
            let html = '';
            a.forEach(c => { html += `<tr><td><strong>${c.Cliente}</strong></td><td><span class="status-badge status-success">${c.CSAT_Interno}</span></td><td>${c.Qtd_Produtos} produtos</td><td>Case de sucesso + refer√™ncia</td></tr>`; });
            document.querySelector('#ancoraTable tbody').innerHTML = html || '<tr><td colspan="4" style="text-align: center; padding: 2rem;">Nenhum cliente √¢ncora</td></tr>';
        }

        function renderProdutividadeChart() {
            const cons = {};
            dadosClientes.forEach(c => {
                const co = c.Consultor_Referencia;
                if (!cons[co]) cons[co] = { rec: 0, h: 0 };
                cons[co].rec += c.Valor_Contrato_Mensal || 0;
                cons[co].h += (c.Horas_Faturadas || 0) + (c.Horas_Nao_Faturadas || 0);
            });
            let html = '';
            const maxProd = 150;
            Object.keys(cons).forEach(co => {
                const p = cons[co].rec / cons[co].h;
                const perc = Math.min((p / maxProd) * 100, 100);
                html += `<div class="chart-bar-wrapper"><div class="bar-info"><span class="bar-label">${co}</span><span class="bar-value">R$ ${p.toFixed(0)}/h</span></div><div class="bar-track"><div class="bar-fill" style="width: ${perc}%"></div></div></div>`;
            });
            document.getElementById('produtividadeChart').innerHTML = html;
        }

        function calcularCSATMedio() {
            const csats = dadosClientes.filter(c => c.CSAT_Interno).map(c => parseFloat(c.CSAT_Interno));
            return csats.length > 0 ? csats.reduce((a, b) => a + b) / csats.length : 0;
        }

        function renderLayerData(id) {
            const renders = { layer1: renderLayer1, layer2: renderLayer2, layer3: renderLayer3, layer4: renderLayer4, layer5: renderLayer5 };
            if (renders[id]) renders[id]();
        }

        function showLoading() {
            document.querySelectorAll('.layer-content').forEach(l => l.innerHTML = '<div class="loading-state"><div class="spinner"></div>Carregando dados...</div>');
        }

        function hideLoading() {}
    </script>
</body>
</html>
